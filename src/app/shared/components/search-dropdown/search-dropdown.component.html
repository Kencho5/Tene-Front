<div class="relative" (outsideClick)="close()">
  <button class="p-2 xl:p-0" (click)="toggle()">
    <svg
      width="24"
      height="24"
      viewBox="0 0 24 24"
      fill="none"
      xmlns="http://www.w3.org/2000/svg"
    >
      <path
        d="M20 20L16.1333 16.1333M18.2222 11.1111C18.2222 15.0385 15.0385 18.2222 11.1111 18.2222C7.18375 18.2222 4 15.0385 4 11.1111C4 7.18375 7.18375 4 11.1111 4C15.0385 4 18.2222 7.18375 18.2222 11.1111Z"
        stroke="#212121"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      />
    </svg>
  </button>

  @if (open()) {
    <div
      class="fixed inset-x-0 bottom-0 top-[72px] z-50 overflow-y-auto bg-white p-5 shadow-lg sm:absolute sm:inset-x-auto sm:-right-10 sm:bottom-auto sm:top-full sm:mt-8 sm:max-h-[80vh] sm:w-[480px] sm:rounded-2xl sm:p-6"
      style="scrollbar-width: none"
    >
      <div class="flex flex-col gap-6">
        <!-- Search input -->
        <div class="relative">
          <svg
            width="20"
            height="20"
            fill="none"
            class="absolute left-4 top-1/2 -translate-y-1/2 text-platinum-50"
          >
            <path
              d="m16.6692 16.6666-3.2222-3.2222m1.7408-4.18523c0 3.27283-2.6531 5.92593-5.92594 5.92593-3.2728 0-5.92592-2.6531-5.92592-5.92593 0-3.27279 2.65312-5.92592 5.92592-5.92592 3.27284 0 5.92594 2.65313 5.92594 5.92592Z"
              stroke="currentColor"
              stroke-width="1.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
          <input
            type="text"
            (input)="query.set($event.target.value)"
            placeholder="ძიება..."
            class="h-[48px] w-full rounded-full border-[1.5px] border-platinum-20 bg-platinum-10 px-4 py-3 pl-11 text-sm outline-none transition-colors focus:border-green-60"
          />
        </div>

        <!-- Search results -->
        @if (results.value()?.products?.length) {
          <div class="space-y-3">
            <h3 class="text-sm font-semibold uppercase tracking-wide text-platinum-50">
              ძებნის შედეგი
            </h3>

            <div class="flex flex-col gap-1">
              @for (
                result of results.value()!.products;
                track result.data.id
              ) {
                <button
                  (click)="openProduct(result.data.id, result.data.name)"
                  class="flex items-center gap-3 rounded-xl p-2.5 transition-colors hover:bg-platinum-10"
                >
                  <img
                    [src]="getImageSrc(result.data.id, result.images[0])"
                    width="48"
                    height="48"
                    class="h-12 w-12 shrink-0 rounded-xl border border-platinum-20 object-cover"
                  />

                  <div class="min-w-0 text-left">
                    <h4 class="truncate text-sm font-medium">
                      {{ result.data.name }}
                    </h4>
                    <p class="text-sm text-platinum-50">
                      {{ result.data.price }} ₾
                    </p>
                  </div>
                </button>
              }
            </div>

            <a
              routerLink="/search"
              [queryParams]="{ query: query() }"
              (click)="close()"
              class="flex h-10 items-center justify-center rounded-full border border-green-60 text-sm font-medium text-green-60 transition-colors hover:bg-green-10"
            >
              მეტის ნახვა
            </a>
          </div>
        } @else if (results.isLoading()) {
          <div class="space-y-3">
            <div
              class="h-4 w-28 animate-pulse rounded bg-platinum-20"
            ></div>
            <div class="flex flex-col gap-1">
              @for (skeleton of [1, 2, 3]; track skeleton) {
                <div class="flex items-center gap-3 rounded-xl p-2.5">
                  <div
                    class="h-12 w-12 flex-shrink-0 animate-pulse rounded-xl bg-platinum-20"
                  ></div>
                  <div class="min-w-0 flex-1 space-y-2">
                    <div
                      class="h-4 w-3/4 animate-pulse rounded bg-platinum-20"
                    ></div>
                    <div
                      class="h-3 w-16 animate-pulse rounded bg-platinum-20"
                    ></div>
                  </div>
                </div>
              }
            </div>
          </div>
        } @else if (query() && results.value()?.products?.length === 0) {
          <p class="py-6 text-center text-sm text-platinum-50">
            შედეგი ვერ მოიძებნა
          </p>
        }

        <!-- Divider -->
        <div class="h-px bg-platinum-20"></div>

        <!-- Categories -->
        <div class="space-y-4">
          <h3 class="text-sm font-semibold uppercase tracking-wide text-platinum-50">
            ტოპ კატეგორიები
          </h3>

          <div
            class="grid grid-cols-4 gap-3 text-center"
          >
            @if (categories.isLoading()) {
              @for (skeleton of [1, 2, 3, 4, 5, 6, 7, 8]; track skeleton) {
                <div class="flex flex-col items-center gap-2">
                  <div
                    class="h-14 w-14 animate-pulse rounded-full bg-platinum-20 sm:h-16 sm:w-16"
                  ></div>
                  <div
                    class="h-3 w-10 animate-pulse rounded bg-platinum-20"
                  ></div>
                </div>
              }
            } @else {
              @for (
                category of categories.value().categories.slice(0, 8);
                track category.id
              ) {
                <a
                  routerLink="/search"
                  [queryParams]="{ category_id: category.id }"
                  (click)="toggle()"
                  class="flex flex-col items-center gap-1.5 rounded-xl p-2 transition-colors hover:bg-platinum-10"
                >
                  <div
                    class="flex h-14 w-14 flex-shrink-0 items-center justify-center sm:h-16 sm:w-16"
                  >
                    <img
                      [src]="category.image_url"
                      class="h-10 w-10 rounded-full sm:h-12 sm:w-12"
                    />
                  </div>

                  <h4 class="line-clamp-2 w-full text-xs leading-tight">
                    {{ category.name }}
                  </h4>
                </a>
              }
            }
          </div>
        </div>
      </div>
    </div>
  }
</div>
