<!-- Mobile backdrop -->
@if (isFilterOpen()) {
  <div
    (click)="isFilterOpen.set(false)"
    class="fixed inset-0 z-50 bg-black/50 md:hidden"
  ></div>
}

<div class="container flex items-start gap-10 px-4 py-10 xl:px-0">
  <!--FILTERS BOX-->
  <div
    [class.hidden]="!isFilterOpen()"
    class="fixed inset-x-0 bottom-0 z-50 max-h-[80vh] space-y-6 overflow-y-auto rounded-t-2xl bg-white p-6 shadow-low md:static md:block md:max-h-none md:w-[350px] md:flex-shrink-0 md:rounded-2xl"
  >
    <div class="flex items-center justify-between">
      <h2 class="text-xl">ფილტრი</h2>
      <div class="flex items-center gap-4">
        <button
          type="button"
          (click)="clearAll()"
          class="text-sm text-platinum-50"
        >
          გასუფთავება
        </button>
        <button
          type="button"
          (click)="isFilterOpen.set(false)"
          class="md:hidden"
        >
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path
              d="M18 6L6 18M6 6L18 18"
              stroke="#6D6D6D"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </button>
      </div>
    </div>

    <div class="space-y-3">
      <p class="font-semibold">ფასი</p>

      <div class="flex gap-3">
        <div class="relative flex-1">
          <input
            type="number"
            [value]="params()['price_from'] ?? ''"
            (input)="
              setParam(
                'price_from',
                $any($event.target).value || undefined,
                400
              )
            "
            placeholder="დან"
            class="w-full rounded-xl border border-platinum-20 p-3.5 outline-none"
          />

          <svg
            width="16"
            height="16"
            viewBox="0 0 16 16"
            fill="none"
            class="absolute right-4 top-1/2 -translate-y-1/2"
          >
            <path
              d="M14 8C14 11.3137 11.3137 14 8 14C4.68629 14 2 11.3137 2 8C2 4.68629 4.68629 2 8 2C11.3137 2 14 4.68629 14 8Z"
              stroke="#888888"
              stroke-width="1.5"
              stroke-linecap="round"
            />
            <path
              d="M5.66786 10.6667V9.96545L6.44348 9.88753V9.85636C5.67586 9.40441 5.33203 8.6174 5.33203 7.72129C5.33203 6.49012 5.97171 5.54727 7.17911 5.25896V4.66675H7.74682V5.17324C7.82678 5.16545 7.91474 5.16545 8.01069 5.16545C8.09865 5.16545 8.17861 5.16545 8.26656 5.17324V4.66675H8.83428V5.25896C10.0497 5.55506 10.6654 6.54467 10.6654 7.94727H9.61789C9.61789 7.0122 9.386 6.37324 8.83428 6.08493V7.93948H8.26656V5.92909C8.1866 5.9135 8.09865 5.9135 8.01069 5.9135C7.91474 5.9135 7.82678 5.9135 7.74682 5.92909V7.93948H7.17911V6.08493C6.62738 6.35766 6.37951 6.96545 6.37951 7.80701C6.37951 9.03818 7.09115 9.84077 8.1946 9.84077H10.3215V10.6667H5.66786Z"
              fill="#888888"
            />
          </svg>
        </div>
        <div class="relative flex-1">
          <input
            type="number"
            [value]="params()['price_to'] ?? ''"
            (input)="
              setParam('price_to', $any($event.target).value || undefined, 400)
            "
            placeholder="მდე"
            class="w-full rounded-xl border border-platinum-20 p-3.5 outline-none"
          />

          <svg
            width="16"
            height="16"
            viewBox="0 0 16 16"
            fill="none"
            class="absolute right-4 top-1/2 -translate-y-1/2"
          >
            <path
              d="M14 8C14 11.3137 11.3137 14 8 14C4.68629 14 2 11.3137 2 8C2 4.68629 4.68629 2 8 2C11.3137 2 14 4.68629 14 8Z"
              stroke="#888888"
              stroke-width="1.5"
              stroke-linecap="round"
            />
            <path
              d="M5.66786 10.6667V9.96545L6.44348 9.88753V9.85636C5.67586 9.40441 5.33203 8.6174 5.33203 7.72129C5.33203 6.49012 5.97171 5.54727 7.17911 5.25896V4.66675H7.74682V5.17324C7.82678 5.16545 7.91474 5.16545 8.01069 5.16545C8.09865 5.16545 8.17861 5.16545 8.26656 5.17324V4.66675H8.83428V5.25896C10.0497 5.55506 10.6654 6.54467 10.6654 7.94727H9.61789C9.61789 7.0122 9.386 6.37324 8.83428 6.08493V7.93948H8.26656V5.92909C8.1866 5.9135 8.09865 5.9135 8.01069 5.9135C7.91474 5.9135 7.82678 5.9135 7.74682 5.92909V7.93948H7.17911V6.08493C6.62738 6.35766 6.37951 6.96545 6.37951 7.80701C6.37951 9.03818 7.09115 9.84077 8.1946 9.84077H10.3215V10.6667H5.66786Z"
              fill="#888888"
            />
          </svg>
        </div>
      </div>
    </div>

    <div class="h-px bg-platinum-20"></div>

    <div class="space-y-6">
      <p class="font-semibold">აქციის ტიპი</p>

      <div class="flex items-center justify-between">
        <p>ფასდაკლება</p>

        <label class="relative inline-block h-5 w-5 cursor-pointer">
          <input
            type="checkbox"
            [checked]="hasValue('sale_type', 'discount')"
            (change)="
              toggleParam('sale_type', 'discount', $any($event.target).checked)
            "
            class="peer sr-only"
          />
          <span
            class="block h-full w-full rounded border border-platinum-30 peer-checked:border-0 peer-checked:bg-green-60"
          ></span>
          <svg
            viewBox="0 0 20 20"
            fill="none"
            class="pointer-events-none absolute left-1/2 top-1/2 hidden h-3 w-3 -translate-x-1/2 -translate-y-1/2 peer-checked:block"
          >
            <path
              d="M16.6667 5L7.50004 14.1667L3.33337 10"
              stroke="white"
              stroke-width="2.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </label>
      </div>

      <div class="flex items-center justify-between">
        <p>ტენე ქულები</p>

        <label class="relative inline-block h-5 w-5 cursor-pointer">
          <input
            type="checkbox"
            [checked]="hasValue('sale_type', 'coins')"
            (change)="
              toggleParam('sale_type', 'coins', $any($event.target).checked)
            "
            class="peer sr-only"
          />
          <span
            class="block h-full w-full rounded border border-platinum-30 peer-checked:border-0 peer-checked:bg-green-60"
          ></span>
          <svg
            viewBox="0 0 20 20"
            fill="none"
            class="pointer-events-none absolute left-1/2 top-1/2 hidden h-3 w-3 -translate-x-1/2 -translate-y-1/2 peer-checked:block"
          >
            <path
              d="M16.6667 5L7.50004 14.1667L3.33337 10"
              stroke="white"
              stroke-width="2.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </label>
      </div>
    </div>

    <div class="h-px bg-platinum-20"></div>

    <!-- Brands Section -->
    <div class="space-y-6">
      <p class="font-semibold">ბრენდი</p>

      @if (isFacetsLoading()) {
        <!-- Loading skeleton -->
        <div class="space-y-4">
          @for (skeleton of [1, 2, 3]; track skeleton) {
            <div class="flex items-center justify-between">
              <div class="h-4 w-24 animate-pulse rounded bg-platinum-20"></div>
              <div class="h-5 w-5 animate-pulse rounded bg-platinum-20"></div>
            </div>
          }
        </div>
      } @else {
        <!-- Brand search input -->
        <div class="relative">
          <input
            type="text"
            [value]="brandSearch()"
            (input)="brandSearch.set($any($event.target).value)"
            placeholder="ძიება..."
            class="w-full rounded-xl border border-platinum-20 p-3 pr-10 text-sm outline-none"
          />
          <svg
            width="20"
            height="20"
            viewBox="0 0 20 20"
            fill="none"
            class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2"
          >
            <path
              d="M9 17C13.4183 17 17 13.4183 17 9C17 4.58172 13.4183 1 9 1C4.58172 1 1 4.58172 1 9C1 13.4183 4.58172 17 9 17Z"
              stroke="#888888"
              stroke-width="1.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
            <path
              d="M19 19L14.65 14.65"
              stroke="#888888"
              stroke-width="1.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>
        </div>

        <!-- Brand list with scroll -->
        <div class="max-h-[200px] space-y-4 overflow-y-auto">
          @for (brand of filteredBrands(); track brand.value) {
            <div
              class="flex items-center justify-between"
              [class.opacity-50]="brand.count === 0"
            >
              <div class="flex items-center gap-2">
                <p>{{ brand.value | titlecase }}</p>
                <span class="text-xs text-platinum-50"
                  >({{ brand.count }})</span
                >
              </div>

              <label class="relative inline-block h-5 w-5 cursor-pointer">
                <input
                  type="checkbox"
                  [checked]="hasValue('brand', brand.value.toLowerCase())"
                  [disabled]="brand.count === 0"
                  (change)="
                    toggleParam(
                      'brand',
                      brand.value.toLowerCase(),
                      $any($event.target).checked
                    )
                  "
                  class="peer sr-only"
                />
                <span
                  class="block h-full w-full rounded border border-platinum-30 peer-checked:border-0 peer-checked:bg-green-60 peer-disabled:cursor-not-allowed"
                ></span>
                <svg
                  viewBox="0 0 20 20"
                  fill="none"
                  class="pointer-events-none absolute left-1/2 top-1/2 hidden h-3 w-3 -translate-x-1/2 -translate-y-1/2 peer-checked:block"
                >
                  <path
                    d="M16.6667 5L7.50004 14.1667L3.33337 10"
                    stroke="white"
                    stroke-width="2.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </label>
            </div>
          }

          @if (filteredBrands().length === 0) {
            <p class="text-sm text-platinum-50">მონაცემები არ მოიძებნა</p>
          }
        </div>
      }
    </div>

    <div class="h-px bg-platinum-20"></div>

    <!-- Colors Section -->
    <div class="space-y-6">
      <p class="font-semibold">ფერი</p>

      @if (isFacetsLoading()) {
        <!-- Loading skeleton -->
        <div class="space-y-4">
          @for (skeleton of [1, 2, 3]; track skeleton) {
            <div class="flex items-center justify-between">
              <div class="h-4 w-20 animate-pulse rounded bg-platinum-20"></div>
              <div class="h-5 w-5 animate-pulse rounded bg-platinum-20"></div>
            </div>
          }
        </div>
      } @else {
        <!-- Colors list -->
        <div class="space-y-4">
          @for (color of facets().colors; track color.value) {
            <div
              class="flex items-center justify-between"
              [class.opacity-50]="color.count === 0"
            >
              <div class="flex items-center gap-2">
                <p>{{ color.value }}</p>
                <span class="text-xs text-platinum-50"
                  >({{ color.count }})</span
                >
              </div>

              <label class="relative inline-block h-5 w-5 cursor-pointer">
                <input
                  type="checkbox"
                  [checked]="hasValue('color', color.value.toLowerCase())"
                  [disabled]="color.count === 0"
                  (change)="
                    toggleParam(
                      'color',
                      color.value.toLowerCase(),
                      $any($event.target).checked
                    )
                  "
                  class="peer sr-only"
                />
                <span
                  class="block h-full w-full rounded border border-platinum-30 peer-checked:border-0 peer-checked:bg-green-60 peer-disabled:cursor-not-allowed"
                ></span>
                <svg
                  viewBox="0 0 20 20"
                  fill="none"
                  class="pointer-events-none absolute left-1/2 top-1/2 hidden h-3 w-3 -translate-x-1/2 -translate-y-1/2 peer-checked:block"
                >
                  <path
                    d="M16.6667 5L7.50004 14.1667L3.33337 10"
                    stroke="white"
                    stroke-width="2.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>
              </label>
            </div>
          }

          @if (facets().colors.length === 0) {
            <p class="text-sm text-platinum-50">მონაცემები არ მოიძებნა</p>
          }
        </div>
      }
    </div>
  </div>

  <div class="w-full space-y-5">
    <h1 class="text-2xl sm:text-4xl">პროდუქტები</h1>

    <div class="h-px bg-platinum-20"></div>

    <div>
      <div class="mb-5">
        <app-breadcrumb [items]="breadcrumbItems" />
      </div>

      <div class="flex w-full items-center justify-between">
        <div class="w-[196px] sm:w-[224px]">
          <app-dropdown
            [selectedValue]="params()['sort_by']"
            (selectedValueChange)="setParam('sort_by', $event)"
            placeholder="სორტირება"
            [items]="sortOptions"
          />
        </div>

        <button
          type="button"
          (click)="isFilterOpen.set(true)"
          class="flex items-center gap-2 rounded-xl border border-platinum-20 px-3 py-2.5 md:hidden"
        >
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path
              d="M4 14H8M6 20V14M6 4V11M10 10H14M12 4V10M12 20V13M16 14H20M18 20V14M18 4V11"
              stroke="#6D6D6D"
              stroke-width="1.5"
              stroke-linecap="round"
              stroke-linejoin="round"
            />
          </svg>

          ფილტრი
        </button>
      </div>
    </div>

    <div class="flex flex-col gap-6 sm:flex-row sm:flex-wrap sm:gap-6">
      @if (isLoading()) {
        @for (skeleton of [].constructor(6); track skeleton) {
          <app-product-card-skeleton />
        }
      } @else {
        @for (product of products(); track $index) {
          <app-product-card [product]="product" />
        }
      }
    </div>
  </div>
</div>
