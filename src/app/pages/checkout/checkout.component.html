<div class="px-4 lg:px-0">
  <div class="container mb-10 mt-24 md:mt-36">
    <h1 class="text-2xl md:text-4xl">შეკვეთის გაფორმება</h1>

    <div class="my-6 h-px bg-platinum-20"></div>

    <app-breadcrumb [items]="breadcrumbs()" />

    <div
      class="container mt-10 flex flex-col justify-between gap-6 xl:flex-row"
    >
      <div class="space-y-6">
        <div class="w-full rounded-2xl bg-white p-4 shadow-low sm:p-6">
          <div class="mb-6">
            <h1 class="text-xl">ჩემი ნივთები</h1>
            <p class="text-sm text-platinum-50">
              დამატებული ნივთები: {{ cartService.itemCount() }}
            </p>
          </div>

          <div class="flex flex-col gap-6">
            @for (item of cartService.items(); track $index) {
              <app-cart-item [item]="item" />
            }
          </div>
        </div>

        <form
          (submit)="handleCheckout($event)"
          novalidate
          class="w-full rounded-2xl bg-white p-4 shadow-low sm:p-6"
        >
          <button
            type="button"
            (click)="toggleSection('contactDetails')"
            class="flex w-full items-center justify-between text-left transition-opacity hover:opacity-70"
          >
            <h1 class="text-xl">1. საკონტაქტო დეტალები</h1>
            <svg
              class="h-6 w-6 flex-shrink-0 text-platinum-70 transition-transform duration-200"
              [class.rotate-180]="!sectionStates().contactDetails"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M19 9l-7 7-7-7"
              />
            </svg>
          </button>

          @if (sectionStates().contactDetails) {
            <div class="mt-4 flex flex-col gap-4">
              <div class="flex gap-3">
                <button
                  type="button"
                  (click)="checkoutForm.customer_type().value.set('individual')"
                  [ngClass]="{
                    'bg-green-60 text-white':
                      checkoutForm.customer_type().value() === 'individual',
                    'bg-green-10 text-green-70':
                      checkoutForm.customer_type().value() !== 'individual',
                  }"
                  class="flex max-h-[33px] items-center rounded-full px-4 py-2 text-sm font-medium transition-all"
                >
                  ფიზიკური
                </button>
                <button
                  type="button"
                  (click)="checkoutForm.customer_type().value.set('company')"
                  [ngClass]="{
                    'bg-green-60 text-white':
                      checkoutForm.customer_type().value() === 'company',
                    'bg-green-10 text-green-70':
                      checkoutForm.customer_type().value() !== 'company',
                  }"
                  class="flex max-h-[33px] items-center rounded-full px-4 py-2 text-sm font-medium transition-all"
                >
                  იურიდიული
                </button>
              </div>

              @if (checkoutForm.customer_type().value() === "individual") {
                <div class="flex w-full gap-4">
                  <div class="flex-1">
                    <app-input
                      [field]="checkoutForm.individual.name"
                      [error]="
                        submitted() && checkoutForm.individual.name().invalid()
                      "
                      type="text"
                      placeholder="სახელი"
                    />
                  </div>

                  <div class="flex-1">
                    <app-input
                      [field]="checkoutForm.individual.surname"
                      [error]="
                        submitted() &&
                        checkoutForm.individual.surname().invalid()
                      "
                      type="text"
                      placeholder="გვარი"
                    />
                  </div>
                </div>
              }

              @if (checkoutForm.customer_type().value() === "company") {
                <div class="flex w-full flex-col gap-4 md:flex-row">
                  <div class="w-full md:w-32">
                    <app-combobox
                      [(selectedValue)]="
                        checkoutForm.company.organization_type().value
                      "
                      [items]="organizationTypes"
                      [error]="
                        submitted() &&
                        checkoutForm.company.organization_type().invalid()
                      "
                      placeholder="ტიპი"
                      searchPlaceholder="ძებნა..."
                      notFoundText="ვერ მოიძებნა"
                    />
                  </div>

                  <div class="w-full md:flex-1">
                    <app-input
                      [field]="checkoutForm.company.organization_name"
                      [error]="
                        submitted() &&
                        checkoutForm.company.organization_name().invalid()
                      "
                      type="text"
                      placeholder="ორგანიზაციის დასახელება"
                    />
                  </div>
                </div>

                <app-input
                  [field]="checkoutForm.company.organization_code"
                  [error]="
                    submitted() &&
                    checkoutForm.company.organization_code().invalid()
                  "
                  type="text"
                  placeholder="საიდენტიფიკაციო კოდი"
                />
              }

              <app-input
                [field]="checkoutForm.email"
                [error]="submitted() && checkoutForm.email().invalid()"
                type="email"
                placeholder="ელ. ფოსტა"
              />

              <app-input
                [field]="checkoutForm.phone_number"
                [error]="submitted() && checkoutForm.phone_number().invalid()"
                type="text"
                placeholder="ტელეფონის ნომერი"
              />
            </div>
          }
        </form>

        <div class="w-full rounded-2xl bg-white p-4 shadow-low sm:p-6">
          <button
            type="button"
            (click)="toggleSection('deliveryDetails')"
            class="flex w-full items-center justify-between text-left transition-opacity hover:opacity-70"
          >
            <h1 class="text-xl">2. მიწოდება</h1>
            <svg
              class="h-6 w-6 flex-shrink-0 text-platinum-70 transition-transform duration-200"
              [class.rotate-180]="!sectionStates().deliveryDetails"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M19 9l-7 7-7-7"
              />
            </svg>
          </button>

          @if (sectionStates().deliveryDetails) {
            <div class="mt-4 flex flex-col gap-4">
              <div class="flex gap-3">
                <button
                  type="button"
                  (click)="checkoutForm.delivery_type().value.set('delivery')"
                  [ngClass]="{
                    'bg-green-60 text-white':
                      checkoutForm.delivery_type().value() === 'delivery',
                    'bg-green-10 text-green-70':
                      checkoutForm.delivery_type().value() !== 'delivery',
                  }"
                  class="flex max-h-[33px] items-center rounded-full px-4 py-2 text-sm font-medium transition-all"
                >
                  ადგილზე
                </button>
                <button
                  type="button"
                  (click)="checkoutForm.delivery_type().value.set('pickup')"
                  [ngClass]="{
                    'bg-green-60 text-white':
                      checkoutForm.delivery_type().value() === 'pickup',
                    'bg-green-10 text-green-70':
                      checkoutForm.delivery_type().value() !== 'pickup',
                  }"
                  class="flex max-h-[33px] items-center rounded-full px-4 py-2 text-sm font-medium transition-all"
                >
                  ჩემით წავიღებ
                </button>
              </div>

              @if (loading().addresses) {
                <div class="flex items-center justify-center py-8">
                  <span class="text-platinum-50">იტვირთება...</span>
                </div>
              } @else if (addresses().length === 0) {
                <div class="mx-auto my-4 max-w-[320px] space-y-6 text-center">
                  <img
                    src="/assets/images/checkout/map-waypoint.webp"
                    width="120"
                    height="120"
                    class="mx-auto"
                  />
                  <div>
                    <h2 class="text-lg">დაამატე მისამართი</h2>
                    <p class="text-sm text-platinum-50">
                      დაამატეთ სასურველი მისაამრთი სადაც გსურთ თქვენი შეკვეთის
                      მოწოდება.
                    </p>
                  </div>

                  <button
                    type="button"
                    (click)="isAddressModalOpen.set(true)"
                    class="inline-flex h-[44px] items-center justify-center gap-2 rounded-full border-[1.5px] border-white/40 px-6 py-3 font-medium text-white"
                    style="
                      background: linear-gradient(
                        90deg,
                        #0ad810 0%,
                        #0bb705 35%,
                        #0bb705 65%,
                        #0ad810 100%
                      );
                      box-shadow: 0px 20px 16px -8px #0ad10426;
                    "
                  >
                    მისამართის დამატება
                  </button>
                </div>
              } @else {
                <div class="flex flex-col gap-4">
                  @for (address of addresses(); track $index) {
                    <button
                      type="button"
                      (click)="checkoutForm.address().value.set(address.address)"
                      [class.border-green-60]="
                        checkoutForm.address().value() === address.address
                      "
                      [class.border-platinum-20]="
                        checkoutForm.address().value() !== address.address
                      "
                      class="flex w-full flex-col rounded-xl border-[1.5px] px-4 py-1 transition-all"
                    >
                      <div class="flex items-center justify-between gap-4 py-4">
                        <div class="flex items-center gap-3">
                          <div
                            class="flex h-10 w-10 flex-shrink-0 items-center justify-center rounded-full bg-platinum-10"
                          >
                            <svg
                              width="20"
                              height="20"
                              viewBox="0 0 20 20"
                              fill="none"
                            >
                              <path
                                d="M10 10.625C11.3807 10.625 12.5 9.50571 12.5 8.125C12.5 6.74429 11.3807 5.625 10 5.625C8.61929 5.625 7.5 6.74429 7.5 8.125C7.5 9.50571 8.61929 10.625 10 10.625Z"
                                stroke="#212121"
                                stroke-width="1.5"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                              />
                              <path
                                d="M16.25 8.125C16.25 13.75 10 18.125 10 18.125C10 18.125 3.75 13.75 3.75 8.125C3.75 6.4674 4.40848 4.87769 5.58058 3.70558C6.75269 2.53348 8.3424 1.875 10 1.875C11.6576 1.875 13.2473 2.53348 14.4194 3.70558C15.5915 4.87769 16.25 6.4674 16.25 8.125Z"
                                stroke="#212121"
                                stroke-width="1.5"
                                stroke-linecap="round"
                                stroke-linejoin="round"
                              />
                            </svg>
                          </div>
                          <div class="flex flex-col items-start text-left">
                            <span class="font-normal">{{ address.address }}</span>
                            <span class="text-sm text-platinum-50">{{
                              address.city
                            }}</span>
                          </div>
                        </div>
                        <div
                          [class.bg-green-60]="
                            checkoutForm.address().value() === address.address
                          "
                          [class.bg-platinum-20]="
                            checkoutForm.address().value() !== address.address
                          "
                          class="flex h-6 w-6 flex-shrink-0 items-center justify-center rounded-full"
                        >
                          <div class="h-2 w-2 rounded-full bg-white"></div>
                        </div>
                      </div>

                      @if (address.details) {
                        <div class="h-px bg-platinum-20"></div>
                        <div class="py-4 text-left text-sm text-platinum-50">
                          {{ address.details }}
                        </div>
                      }
                    </button>
                  }
                </div>
              }

              <button
                class="flex items-center gap-2 text-sm font-semibold text-green-70"
              >
                <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                  <path
                    d="M10.0007 7.33331V9.99998M10.0007 9.99998V12.6666M10.0007 9.99998L12.6673 9.99998M10.0007 9.99998L7.33398 9.99998M16.6673 9.99998C16.6673 13.6819 13.6825 16.6666 10.0007 16.6666C6.31875 16.6666 3.33398 13.6819 3.33398 9.99998C3.33398 6.31808 6.31875 3.33331 10.0007 3.33331C13.6825 3.33331 16.6673 6.31808 16.6673 9.99998Z"
                    stroke="#068C0B"
                    stroke-width="1.5"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  />
                </svg>

                ახალი მისამართის დამატება
              </button>

              <div class="my-4 h-px bg-platinum-20"></div>

              <div class="flex w-full flex-col gap-4 md:flex-row">
                <button
                  type="button"
                  (click)="checkoutForm.delivery_time().value.set('same_day')"
                  [ngClass]="{
                    'border-green-60':
                      checkoutForm.delivery_time().value() === 'same_day',
                    'border-platinum-20':
                      checkoutForm.delivery_time().value() !== 'same_day',
                  }"
                  class="flex h-16 w-full items-center justify-between rounded-xl border-[1.5px] px-4 transition-all md:flex-1"
                >
                  <div class="flex items-center gap-3">
                    <div
                      class="flex h-10 w-10 items-center justify-center rounded-full bg-platinum-10"
                    >
                      <svg
                        width="20"
                        height="20"
                        viewBox="0 0 20 20"
                        fill="none"
                      >
                        <path
                          d="M5.00065 5H8.75065C10.5867 5 12.3157 5.86447 13.4173 7.33333L14.0111 8.12508C14.1128 8.26069 14.2535 8.36205 14.4143 8.41565L15.5277 8.78679C16.2083 9.01365 16.6673 9.65055 16.6673 10.3679V11.6667C16.6673 12.5871 15.9211 13.3333 15.0007 13.3333M15.0007 13.3333C15.0007 14.2538 14.2545 15 13.334 15C12.4135 15 11.6673 14.2538 11.6673 13.3333M15.0007 13.3333C15.0007 12.4129 14.2545 11.6667 13.334 11.6667C12.4135 11.6667 11.6673 12.4129 11.6673 13.3333M8.33398 13.3333C8.33398 14.2538 7.58779 15 6.66732 15C5.74684 15 5.00065 14.2538 5.00065 13.3333M8.33398 13.3333C8.33398 12.4129 7.58779 11.6667 6.66732 11.6667C5.74684 11.6667 5.00065 12.4129 5.00065 13.3333M8.33398 13.3333H11.6673M5.00065 13.3333H3.33398M3.33398 10L5.83398 10M4.16732 7.5L7.50065 7.5M10.0007 8.33333L14.1673 8.33333"
                          stroke="#212121"
                          stroke-width="1.5"
                          stroke-linecap="round"
                        />
                      </svg>
                    </div>
                    <span class="font-normal">იმავე დღეს</span>
                  </div>
                  <div
                    [ngClass]="{
                      'bg-green-60':
                        checkoutForm.delivery_time().value() === 'same_day',
                      'bg-platinum-20':
                        checkoutForm.delivery_time().value() !== 'same_day',
                    }"
                    class="flex h-6 w-6 items-center justify-center rounded-full"
                  >
                    <div class="h-2 w-2 rounded-full bg-white"></div>
                  </div>
                </button>
                <button
                  type="button"
                  (click)="checkoutForm.delivery_time().value.set('next_day')"
                  [ngClass]="{
                    'border-green-60':
                      checkoutForm.delivery_time().value() === 'next_day',
                    'border-platinum-20':
                      checkoutForm.delivery_time().value() !== 'next_day',
                  }"
                  class="flex h-16 w-full items-center justify-between rounded-xl border-[1.5px] px-4 transition-all md:flex-1"
                >
                  <div class="flex items-center gap-3">
                    <div
                      class="flex h-10 w-10 items-center justify-center rounded-full bg-platinum-10"
                    >
                      <svg
                        width="20"
                        height="20"
                        viewBox="0 0 20 20"
                        fill="none"
                      >
                        <path
                          d="M10.0007 6.66665V9.99998L12.084 10.8333M16.6673 9.99998C16.6673 13.6819 13.6825 16.6666 10.0007 16.6666C6.31875 16.6666 3.33398 13.6819 3.33398 9.99998C3.33398 6.31808 6.31875 3.33331 10.0007 3.33331C13.6825 3.33331 16.6673 6.31808 16.6673 9.99998Z"
                          stroke="#212121"
                          stroke-width="1.5"
                          stroke-linecap="round"
                          stroke-linejoin="round"
                        />
                      </svg>
                    </div>
                    <span class="font-normal">2 - 3 სამუშაო დღეში</span>
                  </div>
                  <div
                    [ngClass]="{
                      'bg-green-60':
                        checkoutForm.delivery_time().value() === 'next_day',
                      'bg-platinum-20':
                        checkoutForm.delivery_time().value() !== 'next_day',
                    }"
                    class="flex h-6 w-6 items-center justify-center rounded-full"
                  >
                    <div class="h-2 w-2 rounded-full bg-white"></div>
                  </div>
                </button>
              </div>
            </div>
          }
        </div>

        <div class="w-full rounded-2xl bg-white p-4 shadow-low sm:p-6">
          <button
            type="button"
            (click)="toggleSection('paymentMethod')"
            class="flex w-full items-center justify-between text-left transition-opacity hover:opacity-70"
          >
            <h1 class="text-xl">3. გადახდის მეთოდი</h1>
            <svg
              class="h-6 w-6 flex-shrink-0 text-platinum-70 transition-transform duration-200"
              [class.rotate-180]="!sectionStates().paymentMethod"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M19 9l-7 7-7-7"
              />
            </svg>
          </button>

          @if (sectionStates().paymentMethod) {
            <div class="mt-4 flex flex-col gap-4">
              <button
                type="button"
                class="flex h-16 w-full items-center justify-between rounded-xl border-[1.5px] border-green-60 px-4 transition-all"
              >
                <div class="flex items-center gap-3">
                  <div
                    class="flex h-10 w-10 items-center justify-center rounded-full bg-platinum-10"
                  >
                    <div
                      class="flex h-10 w-10 items-center justify-center rounded-full bg-platinum-10"
                    >
                      <svg
                        width="20"
                        height="20"
                        viewBox="0 0 20 20"
                        fill="none"
                      >
                        <path
                          d="M11.4792 11.489C11.065 11.489 10.7292 11.8247 10.7292 12.239C10.7292 12.6532 11.065 12.989 11.4792 12.989V12.239V11.489ZM13.5561 12.989C13.9703 12.989 14.3061 12.6532 14.3061 12.239C14.3061 11.8247 13.9703 11.489 13.5561 11.489V12.239V12.989ZM3.33399 12.5L4.08399 12.5L4.08399 12.5L3.33399 12.5ZM3.33399 7.5L4.08399 7.5V7.5H3.33399ZM3.33398 8.33333V9.08333H16.6673V8.33333V7.58333H3.33398V8.33333ZM11.4792 12.239V12.989H13.5561V12.239V11.489H11.4792V12.239ZM3.33399 12.5L2.58399 12.5C2.58399 14.2949 4.03906 15.75 5.83399 15.75V15V14.25C4.86749 14.25 4.08399 13.4665 4.08399 12.5L3.33399 12.5ZM16.6673 12.5H15.9173C15.9173 13.4665 15.1338 14.25 14.1673 14.25V15V15.75C15.9623 15.75 17.4173 14.2949 17.4173 12.5H16.6673ZM16.6673 7.5H17.4173C17.4173 5.70507 15.9623 4.25 14.1673 4.25V5V5.75C15.1338 5.75 15.9173 6.5335 15.9173 7.5H16.6673ZM3.33399 7.5H4.08399C4.08399 6.5335 4.8675 5.75 5.83399 5.75V5V4.25C4.03907 4.25 2.58399 5.70507 2.58399 7.5H3.33399ZM16.6673 7.5H15.9173V12.5H16.6673H17.4173V7.5H16.6673ZM3.33399 12.5L4.08399 12.5L4.08399 7.5L3.33399 7.5L2.58399 7.5L2.58399 12.5L3.33399 12.5ZM5.83399 5V5.75H14.1673V5V4.25H5.83399V5ZM14.1673 15V14.25H5.83399V15V15.75H14.1673V15Z"
                          fill="#212121"
                        />
                      </svg>
                    </div>
                  </div>
                  <div class="flex flex-col items-start">
                    <span class="font-normal">ყველა ბანკის ბარათი</span>
                    <span class="text-sm text-platinum-50"
                      >Visa / Mastercard</span
                    >
                  </div>
                </div>
                <div
                  class="flex h-6 w-6 items-center justify-center rounded-full bg-green-60"
                >
                  <div class="h-2 w-2 rounded-full bg-white"></div>
                </div>
              </button>
            </div>
          }
        </div>
      </div>

      <app-price-summary (checkout)="handleCheckout()" />
    </div>
  </div>
</div>

<app-confirmation-modal
  [isOpen]="cartService.isDeleteModalOpen()"
  [title]="'ნივთის წაშლა'"
  [message]="cartService.deleteModalMessage()"
  [confirmText]="'წაშლა'"
  [cancelText]="'გაუქმება'"
  [confirmButtonGradientStart]="'#EF1E07'"
  [confirmButtonGradientEnd]="'#FF5226'"
  (confirm)="cartService.confirmDelete()"
  (cancel)="cartService.closeDeleteModal()"
/>

<app-modal
  [isOpen]="isAddressModalOpen()"
  [title]="'მისამართის დამატება'"
  [cancelText]="'გაუქმება'"
  [acceptText]="'დამატება'"
  (close)="isAddressModalOpen.set(false)"
  (accept)="handleAddressSubmit()"
>
  <div class="flex flex-col gap-4">
    <app-combobox
      [(selectedValue)]="addressForm.city().value"
      [items]="storeCities"
      placeholder="აირჩიეთ ქალაქი"
      searchPlaceholder="ძებნა..."
      notFoundText="ქალაქი ვერ მოიძებნა"
    />

    <app-input
      [field]="addressForm.address"
      type="text"
      placeholder="მისამართი"
    />

    <app-input
      [field]="addressForm.details"
      type="text"
      placeholder="კორპუსი, ბინა, სადარბაზო, სართული და ა.შ."
    />
  </div>
</app-modal>
